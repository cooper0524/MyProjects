{"ast":null,"code":"var _classCallCheck = require(\"/Users/Cooper/Bluxury_Catering/bluxury-catering copy 3/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/Cooper/Bluxury_Catering/bluxury-catering copy 3/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\n/**\r\n * Created by ying.wu on 2017/6/12.\r\n */\nvar fs = require('fs');\n\nvar et = require('elementtree');\n\nvar crypto = require('crypto');\n\nvar url = require('url');\n\nvar querystring = require('querystring');\n\nvar http = require('http');\n\nvar https = require('https'); // const EventEmitter = require('events').EventEmitter;\n\n\nvar APIHelper = /*#__PURE__*/function () {\n  \"use strict\";\n\n  function APIHelper() {\n    _classCallCheck(this, APIHelper);\n\n    this.cont = fs.readFileSync(__dirname + '/../../conf/payment_conf.xml').toString();\n    this.cont_xml = et.parse(this.cont);\n    this.active_merc_info = this.cont_xml.findtext('./MercProfile');\n    this.op_mode = this.cont_xml.findtext('./OperatingMode');\n    this.contractor_stat = this.cont_xml.findtext('./IsProjectContractor');\n    this.merc_info = this.cont_xml.findall(\"./MerchantInfo/MInfo/[@name=\\\"\".concat(this.active_merc_info, \"\\\"]\"));\n    this.ignore_payment = [];\n    this.ignore_info = this.cont_xml.findall('./IgnorePayment//Method');\n\n    for (var t = 0, l = this.ignore_info.length; t < l; t++) {\n      this.ignore_payment.push(this.ignore_info[t].text);\n    }\n\n    if (this.merc_info !== []) {\n      this.merc_id = this.merc_info[0].findtext('./MerchantID');\n      this.hkey = this.merc_info[0].findtext('./HashKey');\n      this.hiv = this.merc_info[0].findtext('./HashIV');\n    } else {\n      throw new Error(\"Specified merchant setting name (\".concat(this.active_merc_info, \") not found.\"));\n    }\n\n    this.date = new Date();\n  }\n\n  _createClass(APIHelper, [{\n    key: \"get_mercid\",\n    value: function get_mercid() {\n      return this.merc_id;\n    }\n  }, {\n    key: \"get_op_mode\",\n    value: function get_op_mode() {\n      return this.op_mode;\n    }\n  }, {\n    key: \"get_ignore_pay\",\n    value: function get_ignore_pay() {\n      return this.ignore_payment;\n    }\n  }, {\n    key: \"get_curr_unixtime\",\n    value: function get_curr_unixtime() {\n      return this.date.getTime().toString().slice(0, 10);\n    }\n  }, {\n    key: \"is_contractor\",\n    value: function is_contractor() {\n      if (this.contractor_stat === 'N') {\n        return false;\n      } else if (this.contractor_stat === 'Y') {\n        return true;\n      } else {\n        throw new Error(\"Unknown [IsProjectContractor] configuration.\");\n      }\n    }\n  }, {\n    key: \"urlencode_dot_net\",\n    value: function urlencode_dot_net(raw_data) {\n      var case_tr = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'DOWN';\n\n      if (typeof raw_data === 'string') {\n        var encode_data = encodeURIComponent(raw_data);\n\n        switch (case_tr) {\n          case 'KEEP':\n            // Do nothing\n            break;\n\n          case 'UP':\n            encode_data = encode_data.toUpperCase();\n            break;\n\n          case 'DOWN':\n            encode_data = encode_data.toLowerCase();\n            break;\n        }\n\n        encode_data = encode_data.replace(/\\'/g, \"%27\");\n        encode_data = encode_data.replace(/\\~/g, \"%7e\");\n        encode_data = encode_data.replace(/\\%20/g, \"+\");\n        return encode_data;\n      } else {\n        throw new Error(\"Data received is not a string.\");\n      }\n    }\n  }, {\n    key: \"encode_special_param\",\n    value: function encode_special_param(params, target_arr) {\n      var urlencode_dotnet = this.urlencode_dot_net;\n\n      if (params.constructor === Object) {\n        target_arr.forEach(function (n) {\n          if (Object.keys(params).includes(n)) {\n            params[n] = urlencode_dotnet(params[n]);\n          }\n        });\n      }\n    }\n  }, {\n    key: \"gen_chk_mac_value\",\n    value: function gen_chk_mac_value(params) {\n      var mode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n\n      if (params.constructor === Object) {\n        // throw exception if param contains CheckMacValue, HashKey, HashIV\n        var sec = ['CheckMacValue', 'HashKey', 'HashIV'];\n        sec.forEach(function (pa) {\n          if (Object.keys(params).includes(pa)) {\n            throw new Error(\"Parameters shouldn't contain \".concat(pa));\n          }\n        });\n        var od = {};\n        var temp_arr = Object.keys(params).sort(function (a, b) {\n          return a.toLowerCase().localeCompare(b.toLowerCase());\n        }); // console.log(temp_arr);\n\n        var raw = temp_arr.forEach(function (key) {\n          od[key] = params[key];\n        });\n        raw = JSON.stringify(od).toLowerCase().replace(/\":\"/g, '=');\n        raw = raw.replace(/\",\"|{\"|\"}/g, '&');\n        raw = this.urlencode_dot_net(\"HashKey=\".concat(this.hkey).concat(raw, \"HashIV=\").concat(this.hiv));\n        console.log(raw);\n        var chksum = \"\";\n\n        switch (mode) {\n          case 0:\n            chksum = crypto.createHash('md5').update(raw).digest('hex');\n            break;\n\n          case 1:\n            chksum = crypto.createHash('sha256').update(raw).digest('hex');\n            break;\n\n          default:\n            throw new Error(\"Unexpected hash mode.\");\n        }\n\n        return chksum.toUpperCase();\n      } else {\n        throw new Error(\"Data received is not a Object.\");\n      }\n    }\n  }, {\n    key: \"gen_aes_encrypt\",\n    value: function gen_aes_encrypt(params) {\n      if (params.constructor === Object) {\n        // throw exception if param contains HashKey, HashIV\n        var sec = ['HashKey', 'HashIV'];\n        sec.forEach(function (pa) {\n          if (Object.keys(params).includes(pa)) {\n            throw new Error(\"Parameters shouldn't contain \".concat(pa));\n          }\n        });\n        var encipher = crypto.createCipheriv('aes-128-cbc', this.hkey, this.hiv);\n        var text = params['PaymentToken'];\n        var encrypted_base64 = Buffer.concat([encipher.update(text), encipher.final()]).toString('base64');\n        return this.urlencode_dot_net(encrypted_base64);\n      } else {\n        throw new Error(\"Data received is not a Object.\");\n      }\n    }\n  }, {\n    key: \"http_request\",\n    value: function http_request(method, api_url, payload) {\n      if (method !== \"GET\" && method !== \"POST\") {\n        throw new Error(\"Only GET & POST method are available.\");\n      }\n\n      var target_url = url.parse(api_url);\n      var postData = querystring.stringify(payload);\n      var http_op;\n\n      if (target_url.protocol === 'https:') {\n        http_op = https;\n      } else if (target_url.protocol === 'http:') {\n        http_op = http;\n      } else {\n        throw new Error(\"Only http & https protocol are available.\");\n      }\n\n      var options = {\n        protocol: target_url['protocol'],\n        hostname: target_url['hostname'],\n        path: target_url['path'],\n        method: method,\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded',\n          'Content-Length': Buffer.byteLength(postData)\n        }\n      };\n      return new Promise(function (resolve, reject) {\n        var req = http_op.request(options, function (res) {\n          console.log(\"STATUS: \".concat(res.statusCode)); // console.log(`HEADERS: ${JSON.stringify(res.headers)}`);\n          // res.setEncoding('utf8');\n\n          var body = [];\n          res.on('data', function (chunk) {\n            // console.log(`BODY: ${chunk}`);\n            body.push(chunk);\n          });\n          res.on('end', function () {\n            // console.log('response data.');\n            // console.log(body);\n            resolve(body);\n          });\n        });\n        req.on('error', function (e) {\n          console.error(\"problem with request: \".concat(e.message));\n          reject(e);\n        });\n        req.write(postData);\n        req.end();\n      });\n    }\n  }, {\n    key: \"gen_html_post_form\",\n    value: function gen_html_post_form(act, id, parameters) {\n      var input_typ = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 'hidden';\n      var submit = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : true;\n      var html = \"<form id=\\\"\" + id + \"\\\" action=\\\"\" + act + \"\\\" method=\\\"post\\\">\";\n      Object.keys(parameters).forEach(function (key) {\n        html += \"<input type=\\\"\" + input_typ + \"\\\" name=\\\"\" + key + \"\\\" id=\\\"\" + key + \"\\\" value=\\\"\" + parameters[key] + \"\\\" />\";\n      });\n\n      if (submit === true) {\n        html += \"<script type=\\\"text/javascript\\\">document.getElementById(\\\"\".concat(id, \"\\\").submit();</script>\");\n      }\n\n      html += \"</form>\"; // console.log(typeof html);\n\n      return html;\n    }\n  }, {\n    key: \"valid_chkmc_string\",\n    value: function valid_chkmc_string(str) {\n      var rtn_obj = {};\n      var rtn_arr = str.split('&');\n      rtn_arr.forEach(function (e) {\n        var param = e.split('=');\n        rtn_obj[param[0]] = param[1];\n      });\n      var chkmac = rtn_obj['CheckMacValue'];\n      delete rtn_obj['CheckMacValue'];\n      var val = '';\n\n      if (chkmac.length === 64) {\n        val = this.gen_chk_mac_value(rtn_obj);\n      } else if (chkmac.length === 32) {\n        val = this.gen_chk_mac_value(rtn_obj, 0);\n      }\n\n      if (chkmac === val) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n  }]);\n\n  return APIHelper;\n}();\n\nmodule.exports = APIHelper;","map":{"version":3,"sources":["/Users/Cooper/Bluxury_Catering/bluxury-catering copy 3/node_modules/ecpay-payment/lib/ecpay_payment/helper.js"],"names":["fs","require","et","crypto","url","querystring","http","https","APIHelper","cont","readFileSync","__dirname","toString","cont_xml","parse","active_merc_info","findtext","op_mode","contractor_stat","merc_info","findall","ignore_payment","ignore_info","t","l","length","push","text","merc_id","hkey","hiv","Error","date","Date","getTime","slice","raw_data","case_tr","encode_data","encodeURIComponent","toUpperCase","toLowerCase","replace","params","target_arr","urlencode_dotnet","urlencode_dot_net","constructor","Object","forEach","n","keys","includes","mode","sec","pa","od","temp_arr","sort","a","b","localeCompare","raw","key","JSON","stringify","console","log","chksum","createHash","update","digest","encipher","createCipheriv","encrypted_base64","Buffer","concat","final","method","api_url","payload","target_url","postData","http_op","protocol","options","hostname","path","headers","byteLength","Promise","resolve","reject","req","request","res","statusCode","body","on","chunk","e","error","message","write","end","act","id","parameters","input_typ","submit","html","str","rtn_obj","rtn_arr","split","param","chkmac","val","gen_chk_mac_value","module","exports"],"mappings":"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","sourcesContent":["/**\r\n * Created by ying.wu on 2017/6/12.\r\n */\r\nconst fs = require('fs');\r\nconst et = require('elementtree');\r\nconst crypto = require('crypto');\r\nconst url = require('url');\r\nconst querystring = require('querystring');\r\nconst http = require('http');\r\nconst https = require('https');\r\n\r\n// const EventEmitter = require('events').EventEmitter;\r\n\r\nclass APIHelper {\r\n    constructor(){\r\n        this.cont = fs.readFileSync(__dirname + '/../../conf/payment_conf.xml').toString();\r\n        this.cont_xml = et.parse(this.cont);\r\n        this.active_merc_info = this.cont_xml.findtext('./MercProfile');\r\n        this.op_mode = this.cont_xml.findtext('./OperatingMode');\r\n        this.contractor_stat = this.cont_xml.findtext('./IsProjectContractor');\r\n        this.merc_info = this.cont_xml.findall(`./MerchantInfo/MInfo/[@name=\"${this.active_merc_info}\"]`);\r\n        this.ignore_payment = [];\r\n        this.ignore_info = this.cont_xml.findall('./IgnorePayment//Method');\r\n        for(let t = 0, l = this.ignore_info.length; t < l; t++) {\r\n            this.ignore_payment.push(this.ignore_info[t].text);\r\n        }\r\n        if (this.merc_info !== []) {\r\n            this.merc_id = this.merc_info[0].findtext('./MerchantID');\r\n            this.hkey = this.merc_info[0].findtext('./HashKey');\r\n            this.hiv = this.merc_info[0].findtext('./HashIV');\r\n        } else {\r\n            throw new Error(`Specified merchant setting name (${this.active_merc_info}) not found.`);\r\n        }\r\n        this.date = new Date();\r\n    }\r\n    get_mercid(){\r\n        return this.merc_id;\r\n    }\r\n    get_op_mode(){\r\n        return this.op_mode;\r\n    }\r\n    get_ignore_pay(){\r\n        return this.ignore_payment;\r\n    }\r\n    get_curr_unixtime(){\r\n        return this.date.getTime().toString().slice(0, 10);\r\n    }\r\n    is_contractor(){\r\n        if (this.contractor_stat === 'N') {\r\n            return false\r\n        } else if (this.contractor_stat === 'Y') {\r\n            return true\r\n        } else {\r\n            throw new Error(\"Unknown [IsProjectContractor] configuration.\");\r\n        }\r\n    }\r\n    urlencode_dot_net(raw_data, case_tr='DOWN'){\r\n        if (typeof raw_data === 'string') {\r\n            let encode_data = encodeURIComponent(raw_data);\r\n            switch (case_tr) {\r\n                case 'KEEP':\r\n                    // Do nothing\r\n                    break;\r\n                case 'UP':\r\n                    encode_data = encode_data.toUpperCase();\r\n                    break;\r\n                case 'DOWN':\r\n                    encode_data = encode_data.toLowerCase();\r\n                    break;\r\n            }\r\n            encode_data = encode_data.replace(/\\'/g,\"%27\");\r\n            encode_data = encode_data.replace(/\\~/g,\"%7e\");\r\n            encode_data = encode_data.replace(/\\%20/g,\"+\");\r\n            return encode_data\r\n        } else {\r\n            throw new Error(\"Data received is not a string.\");\r\n        }\r\n    }\r\n    encode_special_param(params, target_arr){\r\n        let urlencode_dotnet = this.urlencode_dot_net;\r\n        if (params.constructor === Object) {\r\n            target_arr.forEach(function (n) {\r\n                if (Object.keys(params).includes(n)) {\r\n                    params[n] = urlencode_dotnet(params[n]);\r\n                }\r\n            });\r\n        }\r\n    }\r\n    gen_chk_mac_value(params, mode=1){\r\n       if (params.constructor === Object) {\r\n           // throw exception if param contains CheckMacValue, HashKey, HashIV\r\n           let sec = ['CheckMacValue', 'HashKey', 'HashIV'];\r\n           sec.forEach(function (pa) {\r\n               if (Object.keys(params).includes(pa)) {\r\n                   throw new Error(`Parameters shouldn't contain ${pa}`);\r\n               }\r\n           });\r\n\r\n           let od = {};\r\n           let temp_arr = (Object.keys(params).sort(function (a, b) {\r\n               return a.toLowerCase().localeCompare(b.toLowerCase());\r\n           }));\r\n           // console.log(temp_arr);\r\n           let raw = temp_arr.forEach(function (key) {od[key] = params[key];});\r\n           raw = JSON.stringify(od).toLowerCase().replace(/\":\"/g, '=');\r\n           raw = raw.replace(/\",\"|{\"|\"}/g, '&');\r\n           raw = this.urlencode_dot_net(`HashKey=${this.hkey}${raw}HashIV=${this.hiv}`);\r\n           console.log(raw);\r\n\r\n           let chksum = \"\";\r\n           switch (mode){\r\n               case 0:\r\n                   chksum = crypto.createHash('md5').update(raw).digest('hex');\r\n                   break;\r\n               case 1:\r\n                   chksum = crypto.createHash('sha256').update(raw).digest('hex');\r\n                   break;\r\n               default:\r\n                   throw new Error(\"Unexpected hash mode.\");\r\n           }\r\n\r\n           return chksum.toUpperCase();\r\n\r\n       } else {\r\n           throw new Error(\"Data received is not a Object.\");\r\n       }\r\n    }\r\n    gen_aes_encrypt(params){\r\n        if (params.constructor === Object){\r\n            // throw exception if param contains HashKey, HashIV\r\n            let sec = ['HashKey', 'HashIV'];\r\n            sec.forEach(function (pa) {\r\n                if (Object.keys(params).includes(pa)) {\r\n                    throw new Error(`Parameters shouldn't contain ${pa}`);\r\n                }\r\n            });\r\n            let encipher = crypto.createCipheriv('aes-128-cbc', this.hkey, this.hiv);\r\n            let text = params['PaymentToken'];\r\n            let encrypted_base64 = Buffer.concat([encipher.update(text), encipher.final()]).toString('base64');\r\n            return this.urlencode_dot_net(encrypted_base64);\r\n        } else {\r\n            throw new Error(`Data received is not a Object.`);\r\n        }\r\n    }\r\n    http_request(method, api_url, payload){\r\n        if (method !== \"GET\" && method !== \"POST\") {\r\n            throw new Error(\"Only GET & POST method are available.\");\r\n        }\r\n\r\n        var target_url = url.parse(api_url);\r\n        var postData = querystring.stringify(payload);\r\n        var http_op;\r\n\r\n        if (target_url.protocol === 'https:'){\r\n            http_op = https;\r\n        } else if (target_url.protocol === 'http:'){\r\n            http_op = http;\r\n        } else {\r\n            throw new Error(\"Only http & https protocol are available.\");\r\n        }\r\n\r\n        var options = {\r\n            protocol: target_url['protocol'],\r\n            hostname: target_url['hostname'],\r\n            path: target_url['path'],\r\n            method: method,\r\n            headers: {\r\n                'Content-Type': 'application/x-www-form-urlencoded',\r\n                'Content-Length': Buffer.byteLength(postData),\r\n            }\r\n        };\r\n\r\n        return new Promise((resolve, reject) => {\r\n\r\n            const req = http_op.request(options, (res) => {\r\n                console.log(`STATUS: ${res.statusCode}`);\r\n                // console.log(`HEADERS: ${JSON.stringify(res.headers)}`);\r\n                // res.setEncoding('utf8');\r\n                const body = [];\r\n                res.on('data', (chunk) => {\r\n                    // console.log(`BODY: ${chunk}`);\r\n                    body.push(chunk);\r\n                });\r\n                res.on('end', () => {\r\n                    // console.log('response data.');\r\n                    // console.log(body);\r\n                    resolve(body);\r\n                });\r\n            });\r\n            req.on('error', (e) => {\r\n                console.error(`problem with request: ${e.message}`);\r\n                reject(e)\r\n            });\r\n\r\n            req.write(postData);\r\n            req.end();\r\n        });\r\n    };\r\n    gen_html_post_form(act, id, parameters, input_typ='hidden', submit=true){\r\n        var html = \"<form id=\\\"\"+ id +\"\\\" action=\\\"\"+ act + \"\\\" method=\\\"post\\\">\";\r\n        Object.keys(parameters).forEach(function (key) {\r\n            html += \"<input type=\\\"\"+ input_typ +\"\\\" name=\\\"\" + key + \"\\\" id=\\\"\" + key + \"\\\" value=\\\"\" + parameters[key] + \"\\\" />\";\r\n        });\r\n        if (submit === true){\r\n            html += `<script type=\"text/javascript\">document.getElementById(\"${id}\").submit();</script>`;\r\n        }\r\n        html += \"</form>\";\r\n        // console.log(typeof html);\r\n        return html\r\n    }\r\n    valid_chkmc_string(str){\r\n       let rtn_obj = {};\r\n       let rtn_arr = str.split('&');\r\n       rtn_arr.forEach(function (e) {\r\n          let param = e.split('=');\r\n          rtn_obj[param[0]] = param[1];\r\n       });\r\n       let chkmac = rtn_obj['CheckMacValue'];\r\n       delete rtn_obj['CheckMacValue'];\r\n       let val = '';\r\n       if (chkmac.length === 64){\r\n           val = this.gen_chk_mac_value(rtn_obj);\r\n       } else if (chkmac.length === 32) {\r\n           val = this.gen_chk_mac_value(rtn_obj, 0);\r\n       }\r\n       if (chkmac === val){\r\n           return true\r\n       } else {\r\n           return false\r\n       }\r\n\r\n    }\r\n\r\n}\r\nmodule.exports = APIHelper;"]},"metadata":{},"sourceType":"script"}